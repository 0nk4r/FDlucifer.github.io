<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fdlucifer.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":null,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="介绍这篇文章探讨的是Project Zero Issue 2046，一个看似不可利用和简单的bug，结果却以非常复杂的方式被利用。">
<meta property="og:type" content="article">
<meta property="og:title" content="v8中简单bug的复杂漏洞">
<meta property="og:url" content="https://fdlucifer.github.io/2021/01/25/v8-simple-bug-with-complex-exploits/index.html">
<meta property="og:site_name" content="lUc1f3r11&#39;s blog">
<meta property="og:description" content="介绍这篇文章探讨的是Project Zero Issue 2046，一个看似不可利用和简单的bug，结果却以非常复杂的方式被利用。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v8.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v81.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v82.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v83.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v84.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v85.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v86.jpg">
<meta property="article:published_time" content="2021-01-25T12:46:06.000Z">
<meta property="article:modified_time" content="2021-01-28T22:23:10.987Z">
<meta property="article:author" content="lUc1f3r11">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v8.jpg">

<link rel="canonical" href="https://fdlucifer.github.io/2021/01/25/v8-simple-bug-with-complex-exploits/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>v8中简单bug的复杂漏洞 | lUc1f3r11's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">lUc1f3r11's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">by lUc1f3r11</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">39</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">29</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">125</span></a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2021/01/25/v8-simple-bug-with-complex-exploits/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lucifer11.jpg">
      <meta itemprop="name" content="lUc1f3r11">
      <meta itemprop="description" content="all things about infosec & ctf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lUc1f3r11's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          v8中简单bug的复杂漏洞
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-25 20:46:06" itemprop="dateCreated datePublished" datetime="2021-01-25T20:46:06+08:00">2021-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 06:23:10" itemprop="dateModified" datetime="2021-01-29T06:23:10+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>这篇文章探讨的是Project Zero Issue 2046，一个看似不可利用和简单的bug，结果却以非常复杂的方式被利用。</p>
<a id="more"></a>

<p><span class="exturl" data-url="aHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Byb2plY3QtemVyby9pc3N1ZXMvZGV0YWlsP2lkPTIwNDY=">Sergey Glazunov最近在Project Zero bugtracker上披露了2046号问题<i class="fa fa-external-link-alt"></i></span>。</p>
<p>这个问题描述了当开发者决定使用新的Torque语言重新实现两个CodeStubAssembler (CSA)函数时引入的一个bug。这两个函数在JavaScript中用于创建新的FixedArray和FixedDoubleArray对象,尽管乍一看实现看起来有效,缺少一个关键组件: 一个最大长度检查,以确保新创建的数组的长度无法不经过一个预定义的上限。</p>
<p>这bug看起来并不是可利用的(当然,最初如果是自己,就会以为它是unexploitable),但如图所示错误报告, Sergey用TurboFan的typer来获得一个非常强大的exploitation原语: 数组的长度远远大于它的容量。这个原语为攻击者提供了V8堆上的越界访问原语，这很容易导致代码执行。</p>
<p>现在对bug跟踪器中提供的复杂再现案例进行根源分析，看看如何从如此简单的bug中实现如此强大的原语。</p>
<h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><p>如果你想跟随本文，你需要构建V8 8.5.51版本 (commit 64cadfcf4a56c0b3b9d3b5cc00905483850d6559). <span class="exturl" data-url="aHR0cHM6Ly92OC5kZXYvZG9jcy9idWlsZA==">按照此指南获取构建说明<i class="fa fa-external-link-alt"></i></span>. 我推荐使用完整的符号来构建 (修改参数。gn并添加symbol_level = 2这一行).</p>
<p>从x64.release下，可以使用以下命令来编译没有编译器优化的release版本(逐行调试优化后的二进制文件有时会非常烦人):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> grep <span class="string">&#x27;\-O3&#x27;</span> -l &#123;&#125; <span class="string">&quot;;&quot;</span> -<span class="built_in">exec</span> sed -i <span class="string">&#x27;s/\-O3/\-O0/&#x27;</span> &#123;&#125; <span class="string">&quot;;&quot;</span> -ls</span><br></pre></td></tr></table></figure>

<p>如果想要跟随这篇博文中的一些代码示例，建议构建正常的release版本(启用编译器优化)。如果没有这些优化，有些示例将需要非常长的时间才能运行。</p>
<p>从上面链接的bug跟踪器中获取概念的证明。</p>
<h2 id="讲一点历史"><a href="#讲一点历史" class="headerlink" title="讲一点历史"></a>讲一点历史</h2><p>为了理解为什么首先引入这个错误，首先必须了解一点CodeStubAssembler的工作方式，以及为什么要创建Torque来替代它。</p>
<h3 id="在2017年之前V8"><a href="#在2017年之前V8" class="headerlink" title="在2017年之前V8"></a>在2017年之前V8</h3><p>在2017年之前，许多JavaScript内置函数(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvY29uY2F0">Array.prototype.concat<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvbWFw">Array.prototype.map<i class="fa fa-external-link-alt"></i></span>, etc)。虽然这些函数使用了TurboFan (V8的投机优化编译器，后面会详细解释)来尽可能地提高性能，但它们的运行速度不如用本地代码编写的那么快。</p>
<p>对于最常见的内置函数，开发人员会用手工编写的程序集编写非常优化的版本。这是可行的，因为ECMAScript规范(<span class="exturl" data-url="aHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1wcm9wZXJ0aWVzLW9mLXRoZS1hcnJheS1wcm90b3R5cGUtb2JqZWN0">示例<i class="fa fa-external-link-alt"></i></span>)对这些内置函数的描述非常详细。然而，有一个很大的缺点: V8瞄准了大量的平台和架构，这意味着V8开发者必须为每个架构编写和重写所有这些优化的内置函数。由于ECMAScript标准在不断发展，新的语言特性也在不断标准化，因此维护所有这些手写的汇编变得极其繁琐且容易出错。</p>
<p>遇到这个问题后，开发人员开始寻找更好的解决方案。直到将TurboFan引入V8引擎，他们才找到了解决方案。</p>
<h3 id="THE-CODESTUBASSEMBLER"><a href="#THE-CODESTUBASSEMBLER" class="headerlink" title="THE CODESTUBASSEMBLER"></a>THE CODESTUBASSEMBLER</h3><p>TurboFan为低级指令带来了跨平台的中间表示(IR)。V8团队决定在TurboFan之上建立一个新的前端，称之为CodeStubAssembler。CodeStubAssembler定义了一种可移植的汇编语言，开发人员可以使用它来实现优化的内置函数。最重要的是，可移植汇编语言的跨平台特性意味着开发人员只需要编写每个内置函数一次。所有受支持的平台和架构的实际本地代码都留给了TurboFan来编译。<span class="exturl" data-url="aHR0cHM6Ly92OC5kZXYvYmxvZy9jc2E=">可以在这里阅读更多关于CSA的信息<i class="fa fa-external-link-alt"></i></span>。</p>
<p>虽然这是一个很大的改进，但仍然有一个小问题。用CodeStubAssembler的语言编写最优代码需要开发人员在头脑中携带大量专业知识。即使掌握了所有这些知识，仍然存在许多经常导致安全漏洞的重要陷阱。这使得V8团队最终编写了一个他们称之为Torque的新组件。</p>
<h3 id="TORQUE"><a href="#TORQUE" class="headerlink" title="TORQUE"></a>TORQUE</h3><p>Torque是一种构建在CodeStubAssembler之上的语言前端。它拥有类似于typescript的语法、强大的类型系统和出色的错误检查功能，这一切都使它成为V8开发者编写内置函数的绝佳选择。Torque编译器使用CodeStubAssembler将Torque代码转换为有效的汇编代码。它极大地减少了安全漏洞的数量，同时也减少了新的V8开发者以前在学习如何用CSA汇编语言编写高效内置函数时所面临的陡峭学习曲线。<span class="exturl" data-url="aHR0cHM6Ly92OC5kZXYvZG9jcy90b3JxdWU=">可以在这里阅读更多关于Torque的内容<i class="fa fa-external-link-alt"></i></span>.</p>
<h3 id="THE-REASON-FOR-THE-BUG"><a href="#THE-REASON-FOR-THE-BUG" class="headerlink" title="THE REASON FOR THE BUG"></a>THE REASON FOR THE BUG</h3><p>因为Torque仍然是相对较新的，仍然有相当数量的CSA代码需要在其中重新实现。这包括处理创建新的FixedArray和FixedDoubleArray对象的CSA代码，这是V8中的“快速”数组(“快速”数组有连续的数组后备存储，而“慢”数组有基于字典的后备存储)。</p>
<p>2046号问题中的实际错误源于开发人员决定在Torque中重新实现这个数组创建内置函数。不幸的是，重新实现错过了一个关键的安全检查，这导致了一个可利用的条件。</p>
<h2 id="The-bug"><a href="#The-bug" class="headerlink" title="The bug"></a>The bug</h2><p>开发人员重新实现了<span class="exturl" data-url="aHR0cHM6Ly9jcy5jaHJvbWl1bS5vcmcvY2hyb21pdW0vc3JjL3Y4L3NyYy9jb2RlZ2VuL2NvZGUtc3R1Yi1hc3NlbWJsZXIuY2M/cmNsPTVkYjRhMjhlZjc1Zjg5M2U4NWI3ZjUwNWY1NTI4Y2MzOWU5ZGVlZjUmbD0zODA1">CodeStubAssembler::AllocateFixedArray<i class="fa fa-external-link-alt"></i></span> 函数两个Torque宏，一个用于FixedArray对象，另一个用于FixedDoubleArray对象:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">macro NewFixedArray&lt;Iterator: <span class="built_in">type</span>&gt;(length: intptr, it: Iterator): FixedArray &#123;</span><br><span class="line">  <span class="keyword">if</span> (length == 0) <span class="built_in">return</span> kEmptyFixedArray;</span><br><span class="line">  <span class="built_in">return</span> new</span><br><span class="line">  FixedArray&#123;map: kFixedArrayMap, length: Convert&lt;Smi&gt;(length), objects: ...it&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">macro NewFixedDoubleArray&lt;Iterator: <span class="built_in">type</span>&gt;(</span><br><span class="line">    length: intptr, it: Iterator): FixedDoubleArray|EmptyFixedArray &#123;</span><br><span class="line">  <span class="keyword">if</span> (length == 0) <span class="built_in">return</span> kEmptyFixedArray;</span><br><span class="line">  <span class="built_in">return</span> new FixedDoubleArray&#123;</span><br><span class="line">    map: kFixedDoubleArrayMap,</span><br><span class="line">    length: Convert&lt;Smi&gt;(length),</span><br><span class="line">    floats: ...it</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将上述函数与CodeStubAssembler::AllocateFixedArray变量进行比较，就会注意到最大长度检查缺失。</p>
<ul>
<li><p>NewFixedArray应该确保返回的新FixedArray的长度低于FixedArray::kMaxLength，即0x7fffffd或134217725。</p>
</li>
<li><p>同样，NewFixedDoubleArray应该根据FixedDoubleArray::kMaxLength检查数组的长度，即0x3fffffe或67108862。</p>
</li>
</ul>
<p>在了解如何处理这个缺失的长度检查之前，先了解一下Sergey是如何触发这个错误的，因为这并不像创建一个大于kMaxLength的数组那么简单。</p>
<h2 id="v8中的数组"><a href="#v8中的数组" class="headerlink" title="v8中的数组"></a>v8中的数组</h2><p>为了理解概念证明，需要了解更多关于V8中数组是如何表示的。如果已经知道这是如何工作的，可以直接跳到下一节。</p>
<h2 id="内存中的数组"><a href="#内存中的数组" class="headerlink" title="内存中的数组"></a>内存中的数组</h2><p>以数组[1,2,3,4]为例，在内存中查看它。可以运行带有–allow-native-syntax flag的V8，创建数组，并使用%DebugPrint(array)来获取它的地址。使用GDB查看内存中的地址。用一个图表来代替。</p>
<p>当在V8中分配一个数组时，它实际上分配了两个对象。注意每个字段的长度都是4字节/32位:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">       A JSArray object                      A FixedArray object</span><br><span class="line">+-----------------------------+       +------------------------------+</span><br><span class="line">|                             |       |                              |</span><br><span class="line">|         Map Pointer         |   +--&gt;+         Map Pointer          |</span><br><span class="line">|                             |   |   |                              |</span><br><span class="line">+-----------------------------+   |   +------------------------------+</span><br><span class="line">|                             |   |   |                              |</span><br><span class="line">|      Properties Pointer     |   |   |     Backing Store Length     |</span><br><span class="line">|                             |   |   |                              |</span><br><span class="line">+-----------------------------+   |   +------------------------------+</span><br><span class="line">|                             |   |   |                              |</span><br><span class="line">|       Elements Pointer      +---+   |          0x00000002          | index 0</span><br><span class="line">|                             |       |                              |</span><br><span class="line">+-----------------------------+       +------------------------------+</span><br><span class="line">|                             |       |                              |</span><br><span class="line">|        Array Length         |       |          0x00000004          | index 1</span><br><span class="line">|                             |       |                              |</span><br><span class="line">+-----------------------------+       +------------------------------+</span><br><span class="line">|                             |       |                              |</span><br><span class="line">| Other unimportant fields... |       |          0x00000006          | index 2</span><br><span class="line">|                             |       |                              |</span><br><span class="line">+-----------------------------+       +------------------------------+</span><br><span class="line">                                      |                              |</span><br><span class="line">                                      |          0x00000008          | index 3</span><br><span class="line">                                      |                              |</span><br><span class="line">                                      +------------------------------+</span><br></pre></td></tr></table></figure>

<p>JSArray对象是实际的数组。它包含四个重要的字段(以及其他一些不重要的字段)。这些是:</p>
<ol>
<li><p>map指针 —— 它决定了数组的“形状”。具体来说，它确定数组存储的元素类型，以及它的后备存储对象的类型。在本例中，数组存储整数，后备存储是一个FixedArray。</p>
</li>
<li><p>属性指针 —— 该指针指向存储数组可能具有的所有属性的对象。在本例中，数组除了长度之外没有任何属性，长度以内联方式存储在JSArray对象本身中。</p>
</li>
<li><p>元素指针 —— 它指向存储数组元素的对象。这也被称为后备存储。在本例中，后备存储指向FixedArray对象。稍后再详细介绍。</p>
</li>
<li><p>数组长度 —— 这是数组的长度。在Sergey的概念证明中，这是覆盖到0x24242424的长度字段，然后允许读和写越界。</p>
</li>
</ol>
<p>JSArray对象的elements指针指向后备存储，这是一个FixedArray对象。这里有两点需要记住:</p>
<ul>
<li><p>FixedArray中的后备存储长度完全无关紧要。可以把它改写成任何值但仍然不能读或写越界。</p>
</li>
<li><p>每个索引存储在数组的元素上。内存中值的表示形式由数组的“元素种类”决定，该数组由原始JSArray对象的映射决定。在本例中，这些值是小整数，是31位整数，底部位设置为0。1表示为1 &lt;&lt; 1 = 2,2表示为2 &lt;&lt; 1 = 4，以此类推。</p>
</li>
</ul>
<p>元素类型是什么意思?</p>
<h2 id="元素类型"><a href="#元素类型" class="headerlink" title="元素类型"></a>元素类型</h2><p>V8中的数组也有一个元素类型的概念. <span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2UuY2hyb21pdW0ub3JnL2Nocm9taXVtL3Y4L3Y4LmdpdC8rLzVkYjRhMjhlZjc1Zjg5M2U4NWI3ZjUwNWY1NTI4Y2MzOWU5ZGVlZjU6c3JjL29iamVjdHMvZWxlbWVudHMta2luZC5oO2w9MzE=">在这里找到所有元素类型的列表<i class="fa fa-external-link-alt"></i></span>, 但是基本的思想是这样的: 在V8中，任何时候创建一个数组，它都被标记为一个elements kind，它定义了数组包含的元素的类型。三种最常见的元素类型如下:</p>
<ul>
<li>PACKED_SMI_ELEMENTS: 该数组是打包的(即没有洞)，只包含Smis(31位小整数，第32位设为0)。</li>
<li>PACKED_DOUBLE_ELEMENTS: 和上面的相同，但用于双精度(64位浮点值)。</li>
<li>PACKED_ELEMENTS: 和上面一样，不同的是数组只包含引用。这意味着它可以包含任何类型的元素(整数、双精度浮点数、对象等)。</li>
</ul>
<p>这些类型的元素还有一个有洞的变体(HOLEY_SMI_ELEMENTS，等等)，它告诉引擎数组中可能有洞(例如，[1,2，，，4])。</p>
<p>数组也可以在元素类型之间进行转换，但是这种转换只能指向更一般的元素类型，而不能指向更具体的元素类型。例如，PACKED_SMI_ELEMENTS类型的数组可以转换为HOLEY_SMI_ELEMENTS类型的数组，但是转换不能以相反的方式发生(即填充已经有洞的数组中的所有洞不会导致转换到已填充的元素类型变体)。</p>
<p>这张图展示了最常见的元素类型的过渡(从这篇<span class="exturl" data-url="aHR0cHM6Ly92OC5kZXYvYmxvZy9lbGVtZW50cy1raW5kcw==">a V8 blog post<i class="fa fa-external-link-alt"></i></span>建议读它来了解元素种类的更多信息):</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v8.jpg"></li>
</ul>
<p>元素类过渡</p>
<p>在这篇博文中，只关心属于元素类型的两件事:</p>
<ul>
<li><p>SMI_ELEMENTS和DOUBLE_ELEMENTS类数组将它们的元素存储在一个连续数组后备存储器中，作为它们在内存中的实际表示形式。例如，数组[1.1, 1.1, 1.1]将存储0x3ff199999999999a到内存中一个由三个元素组成的连续数组中(0x3ff199999999999a是1.1的IEEE-754表示)。另一方面，PACKED_ELEMENTS类型数组将存储三个对HeapNumber对象的连续引用，而HeapNumber对象又包含1.1的IEEE-754表示。还有一些基于字典的后备存储的元素种类，但这对本文来说并不重要。</p>
</li>
<li><p>因为SMI_ELEMENTS和DOUBLE_ELEMENTS类型数组的元素有不同的大小(Smis是31位整数，而double是64位浮点值)，所以它们也有不同的kMaxLength值。</p>
</li>
</ul>
<h2 id="THE-POCS"><a href="#THE-POCS" class="headerlink" title="THE POCS"></a>THE POCS</h2><p>Sergey提供了两种证据的概念: 第一个给了一个数组长度的一种HOLEY_SMI_ELEMENTS FixedArray::kMaxLength + 3, 而第二个给了一个数组长度的一种 HOLEY_DOUBLE_ELEMENTS FixedDoubleArray::kMaxLength + 1。只是利用概念的第二个证明来构造最终的越界访问原语，稍后看看为什么这样做。</p>
<p>这两个概念的证明都使用了Array.prototype.concat最初获得一个数组，其大小刚好低于对应元素类型的kMaxLength值。一旦完成，Array.prototype.splice用于向数组中添加更多元素，这将导致其长度超过kMaxLength。这是因为Array.prototype.splice的快速路径间接利用新的Torque函数来分配新的数组，如果原来的数组不够大。好奇的人可能会发现，实现这一目的的函数调用链如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// builtins/array-splice.tq</span><br><span class="line">ArrayPrototypeSplice -&gt; FastArraySplice -&gt; FastSplice -&gt; Extract -&gt; ExtractFixedArray -&gt; NewFixedArray</span><br></pre></td></tr></table></figure>

<p>可能想知道为什么不能创建一个大小刚好低于FixedArray::kMaxLength的大数组并使用它。试试(使用优化的release版本，除非想等待很长时间):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ./d8</span><br><span class="line">V8 version 8.5.51</span><br><span class="line">d8&gt; Array(0x7fffff0) // FixedArray::kMaxLength is 0x7fffffd</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># javascript OOM数组长度无效</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">Received signal 4 ILL_ILLOPN 5650cf681d62</span><br><span class="line"></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>这不仅需要一些时间来运行，还会得到一个OOM(内存不足)错误!发生这种情况的原因是数组的分配不是一次性完成的。对AllocateRawFixedArray有大量调用，每个调用都分配一个稍大一些的数组。在GDB中，可以通过在AllocateRawFixedArray设置断点，然后像上面所示的那样分配数组来看到这一点。不完全确定V8为什么这样做，但是这么多的分配会导致V8很快耗尽内存。</p>
<p>另一个想法是使用FixedDoubleArray::kMaxLength代替，因为它明显更小(再次使用优化的release版本):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// FixedDoubleArray::kMaxLength = 0x3fffffe</span><br><span class="line"><span class="built_in">let</span> array = (new Array(0x3fffffd)).fill(1.1);</span><br><span class="line">array.splice(array.length, 0, 3.3, 3.3); // Length is now 0x4000000</span><br></pre></td></tr></table></figure>

<p>这确实有效，它返回一个新的HOLEY_DOUBLE_ELEMENTS类型数组，其长度设置为FixedDoubleArray::kMaxLength + 1，因此可以使用它来代替array.prototype.concat。相信这个工作的原因是，分配大小为0x3fffffd的数组所需的分配数量足够小，不会导致引擎走向OOM。</p>
<p>不过，这种方法有两个很大的缺点: 分配和填充这么大的数组需要相当多的时间(至少在我的机器上是这样)，因此它在利用上不太理想。另一个问题是，在内存受限的环境(如旧手机)中以这种方式触发漏洞可能会导致引擎崩溃.</p>
<p>另一方面，Sergey的第一个poc在我的机器上只花了2秒，而且内存效率很高，所以分析一下.</p>
<h2 id="第一个poc"><a href="#第一个poc" class="headerlink" title="第一个poc"></a>第一个poc</h2><p>第一个poc如下。确保使用优化的release版本来运行它，否则它将需要非常长的时间才能完成:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array = Array(0x80000).fill(1); // [1]</span><br><span class="line">array.prop = 1; // [2]</span><br><span class="line">args = Array(0x100 - 1).fill(array); // [3]</span><br><span class="line">args.push(Array(0x80000 - 4).fill(2)); // [4]</span><br><span class="line">giant_array = Array.prototype.concat.apply([], args); // [5]</span><br><span class="line">giant_array.splice(giant_array.length, 0, 3, 3, 3, 3); // [6]</span><br></pre></td></tr></table></figure>

<p>一步一步来分析.</p>
<p>在[1]上，创建一个大小为0x80000的数组，并用1填充。这种大小的数组需要大量的分配，但这并不能让引擎变得强大。因为数组最初是空的，所以它获得一个HOLEY_SMI_ELEMENTS类型，并且在它被1填充之后仍然保留该元素类型.</p>
<p>稍后会回到[2]，但是在[3]，一个新的args数组是用0xff元素创建的。每个元素都被设置为在[1]处创建的数组。这给args数组提供了总共0xff * 0x80000 = 0x7f80000个元素。在[4]处，另一个大小为0x7fffc的数组被推入args数组，这将使它的元素总数为0x7f80000 + 0x7fffc = 0x7fffffc。0x7fffffc仅仅比FixedDoubleArray::kMaxLength = 0x7fffffd少一个.</p>
<p>在[5]处, Array.prototype.concat.apply将args数组中的每个元素连接到空数组[]. <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvRnVuY3Rpb24vYXBwbHk=">You can read more about how<i class="fa fa-external-link-alt"></i></span> Function.prototype.apply() <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvRnVuY3Rpb24vYXBwbHk=">works here<i class="fa fa-external-link-alt"></i></span>, 但它实际上将args视为参数数组，并将每个元素连接到最终结果数组。我们知道元素的总数是0x7fffffc，所以最终的数组会有这么多元素。这种连接进行得有点快(在我的机器上大约需要2秒)，尽管它比前面展示的简单创建数组要快得多.</p>
<p>最后, 在[6], Array.prototype.splice向数组添加4个额外元素，这意味着它的长度现在是0x8000000，即FixedArray::kMaxLength + 3.</p>
<p>唯一需要解释的是[2]，其中一个属性被添加到原始数组中。要理解这一点，必须首先理解，对于几乎所有的V8内置函数来说，一个约定是有一个快的路径和一个慢的路径。在Array.prototype.concat的情况下，一种采用慢路径的简单方法是向正在连接的数组添加属性(实际上，这是大多数Array.prototype采用慢路径的一种简单方法。*内置函数)。为什么Sergey想要走慢路? 因为快速路径有以下代码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// builtins/builtins-array.cc:1414</span><br><span class="line">MaybeHandle&lt;JSArray&gt; Fast_ArrayConcat(Isolate* isolate,</span><br><span class="line">                                      BuiltinArguments* args) &#123;</span><br><span class="line">  // ...</span><br><span class="line">  </span><br><span class="line">  // 如果超出FixedArray限制，则抛出错误</span><br><span class="line">  <span class="keyword">if</span> (FixedDoubleArray::kMaxLength &lt; result_len ||</span><br><span class="line">      FixedArray::kMaxLength &lt; result_len) &#123;</span><br><span class="line">    AllowHeapAllocation gc;</span><br><span class="line">    THROW_NEW_ERROR(isolate,</span><br><span class="line">                    NewRangeError(MessageTemplate::kInvalidArrayLength),</span><br><span class="line">                    JSArray);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>如所见，快速路径检查以确保最终数组的长度不超过任何一个kMaxLength值。因为FixedDoubleArray::kMaxLength是FixedArray::kMaxLength的一半，上面的poc永远不会通过这个检查。可以尝试在不使用数组的情况下运行代码array.prop = 1;看看会发生什么!</p>
<p>另一方面，慢路径(Slow_ArrayConcat)没有任何长度检查(但如果长度超过FixedArray::kMaxLength，它仍然会崩溃，因为它调用的其中一个函数仍然会检查这个长度)。这就是为什么Sergey的poc使用了慢路径: 绕过存在于快速路径上的检查.</p>
<h2 id="第二个poc-第一部分"><a href="#第二个poc-第一部分" class="headerlink" title="第二个poc-第一部分"></a>第二个poc-第一部分</h2><p>尽管第一个poc证明了该漏洞并可用于利用(只需稍微修改第二个poc中的触发器函数)，但需要几秒钟才能完成(在优化的release版本上)，这可能不是理想的。Sergey选择使用一个HOLEY_DOUBLE_ELEMENTS类型数组来代替。这可能是因为FixedDoubleArray::kMaxLength值明显小于它的FixedArray变量，导致更快的触发(在未优化的构建上几乎是即时的)。如果理解了第一个poc，那么下面关于第二个poc的第一部分的注释应该是不言自明的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// HOLEY_DOUBLE_ELEMENTS类型，size=0x40000，填充1.1</span><br><span class="line">array = Array(0x40000).fill(1.1);</span><br><span class="line"></span><br><span class="line">// <span class="string">&#x27;args&#x27;</span>中的元素总数: 0x40000 * 0xff = 0x3fc0000</span><br><span class="line">args = Array(0x100 - 1).fill(array);</span><br><span class="line"></span><br><span class="line">// 我们想要一个大小,略低于FixedDoubleArray::kMaxLength = 0x3ffffe 新数组“参数”可以有最大大小(0x40000 - 2),但Sergey选择使用(0x40000 - 4)的元素总数“参数”: 0x3fc0000 + 0x3fffcx3fffffc = 0</span><br><span class="line">args.push(Array(0x40000 - 4).fill(2.2));</span><br><span class="line"></span><br><span class="line">// Array.prototype.concat快速路径，长度检查通过，当<span class="string">&#x27;giant_array&#x27;</span>的最终长度变成0x3fffffc，它等于<span class="string">&#x27;FixedDoubleArray::kMaxLength - 2&#x27;</span></span><br><span class="line">giant_array = Array.prototype.concat.apply([], args);</span><br><span class="line"></span><br><span class="line">// Array.prototype没有长度检查拼接, giant_array.length现在是0x3ffffff，它是<span class="string">&#x27;FixedDoubleArray::kMaxLength + 1&#x27;</span></span><br><span class="line">giant_array.splice(giant_array.length, 0, 3.3, 3.3, 3.3);</span><br></pre></td></tr></table></figure>

<p>一旦到了这一点，giant_array的长度是0x3ffffff，这是FixedDoubleArray::kMaxLength + 1。现在的问题是，如何利用这个数组?没有立即得到任何有用的原语，因此需要找到引擎的其他部分，其代码依赖于数组长度永远不能超过kMaxLength值这一事实.</p>
<p>对于大多数研究人员来说，这个bug本身是很容易发现的，因为只需要比较函数的新Torque实现和旧的。但是，要知道如何利用它，需要对V8本身有更深入的了解。Sergey采用的开发途径是使用V8的投机性优化编译器TurboFan，这需要自己的介绍.</p>
<h2 id="TURBOFAN"><a href="#TURBOFAN" class="headerlink" title="TURBOFAN"></a>TURBOFAN</h2><p>请注意，TurboFan是V8发动机的一个极其复杂的组成部分。可以很容易地用几个小时来讨论它的内部结构，因此本节不会是一个详尽的介绍。</p>
<p>如果已经知道TurboFan是如何工作的，可以跳过这一节。</p>
<h3 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h3><p>和现在大多数大型JavaScript引擎一样，V8一开始只是一个JavaScript的解释器。随着计算机变得越来越强大，人们想要开始在浏览器中运行越来越复杂的应用程序，面对现实吧，基于浏览器的应用程序更容易移植。尽管只有一个解释器，V8很快就达到了性能限制.</p>
<p>当达到这个极限时，V8开发人员就制造了TurboFan(好吧，也不完全是。他们首先构建了Crankshaft，但不讨论它)，这是一个投机性优化编译器，它使用解释器的类型反馈将JavaScript代码编译为本地机器代码。下图大致展示了V8当前的工作方式(<span class="exturl" data-url="aHR0cHM6Ly9wb255Zm9vLmNvbS9hcnRpY2xlcy9hbi1pbnRyb2R1Y3Rpb24tdG8tc3BlY3VsYXRpdmUtb3B0aW1pemF0aW9uLWluLXY4">从这篇博客上摘取<i class="fa fa-external-link-alt"></i></span>):</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v81.jpg"></li>
</ul>
<p>V8管道执行</p>
<h3 id="投机优化"><a href="#投机优化" class="headerlink" title="投机优化"></a>投机优化</h3><p>TurboFan在一个函数一个函数的基础上编译JavaScript代码。在JavaScript中，函数最初几次被调用时，解释器会执行它，解释器会收集类型反馈。在此上下文中，类型反馈只是指传递到函数中/在函数中使用的类型的信息。这种类型的反馈随后被TurboFan用于 “推测性” 优化，这基本上意味着TurboFan将使用这种类型的反馈进行假设，从而生成本地代码。</p>
<p>来看一个例子。假设有以下代码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> add(val1, val2) &#123;</span><br><span class="line">    <span class="built_in">return</span> val1 + val2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 收集类型反馈: val1、val2和返回值都是Smis</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">let</span> i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">    add(5, 10);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Deoptimize</span><br><span class="line">add(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>当在循环中调用add(5,10) 10000次时，解释器收集类型反馈，TurboFan将使用这些反馈进行假设并生成本机汇编代码，将val1和val2简单地添加在一起，就像它们是Smis一样。</p>
<p>本机程序集代码运行得非常快，但这里有一个问题。JavaScript是一种动态类型语言，所以没有什么可以阻止向add函数传递字符串或对象。TurboFan需要防止这种情况，因为将两个字符串相加与将两个数字相加是完全不同的，所以在两种情况下运行相同的本地代码会导致bug。为了防止这种情况发生，在本地代码中插入了类型保护，以检查val1和val2都是Smi类型。只有在类型检查通过时才执行本机代码。如果任何一个检查失败，那么代码将被反优化，并将执行“保释”给解释器，解释器可以处理所有情况。</p>
<p>用V8的–trace-opt和–trace-deopt flag运行上面的代码，看看优化和反优化是如何进行的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./d8 --trace-opt --trace-deopt test.js </span><br><span class="line">[marking 0x3a130821018d &lt;JSFunction (sfi = 0x3a1308210005)&gt; <span class="keyword">for</span> optimized recompilation, reason: small <span class="keyword">function</span>]</span><br><span class="line">[compiling method 0x3a130821018d &lt;JSFunction (sfi = 0x3a1308210005)&gt; using TurboFan OSR]</span><br><span class="line">[optimizing 0x3a130821018d &lt;JSFunction (sfi = 0x3a1308210005)&gt; - took 0.346, 0.588, 0.013 ms]</span><br><span class="line">[deoptimizing (DEOPT soft): begin 0x3a130821018d &lt;JSFunction (sfi = 0x3a1308210005)&gt; (opt <span class="comment">#0) @3, FP to SP delta: 88, caller sp: 0x7ffd2039baa8]</span></span><br><span class="line">            ;;; deoptimize at &lt;test.js:9:1&gt;, Insufficient <span class="built_in">type</span> feedback <span class="keyword">for</span> call</span><br></pre></td></tr></table></figure>

<p>可以看到，由于 “调用的类型反馈不足” ，函数得到了优化，后来又被取消优化，这是有意义的! 从未使用字符串调用函数，因此没有要引用的类型反馈，因此出现了反优化。</p>
<h2 id="优化阶段"><a href="#优化阶段" class="headerlink" title="优化阶段"></a>优化阶段</h2><p>TurboFan不仅仅是一个推测编译器。它也是一个优化编译器，这意味着它有许多不同的优化阶段。下图显示了一个粗略的管道(<span class="exturl" data-url="aHR0cHM6Ly9hYmlvbmRvLm1lLzIwMTkvMDEvMDIvZXhwbG9pdGluZy1tYXRoLWV4cG0xLXY4Lw==">taken from this blog post<i class="fa fa-external-link-alt"></i></span>):</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v82.jpg"></li>
</ul>
<p>TurboFan优化阶段(注: 不是详尽的图)</p>
<p>如果上过编译器课程(或以前学过编译器)，那么这些术语对您来说可能很熟悉。它们只是TurboFan在某些优化阶段执行的编译器优化。但是，在解析器生成的AST上进行这些优化非常困难，因此TurboFan将AST转换为另一种表示形式: “节点的海洋” 图。</p>
<h3 id="节点的海洋"><a href="#节点的海洋" class="headerlink" title="节点的海洋"></a>节点的海洋</h3><p>TurboFan在源代码的大量节点表示上进行优化。提供它如何工作的简要总结，可以参考这两者<span class="exturl" data-url="aHR0cHM6Ly9kb2FyLWUuZ2l0aHViLmlvL2Jsb2cvMjAxOS8wMS8yOC9pbnRyb2R1Y3Rpb24tdG8tdHVyYm9mYW4vI3NlYS1vZi1ub2Rlcw==">这篇博文<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9kYXJrc2kuZGUvZC5zZWEtb2Ytbm9kZXMv">这篇博文<i class="fa fa-external-link-alt"></i></span>如果想更好地理解它的话.</p>
<p>节点海图中的节点可以表示高级操作，也可以表示低级操作。节点本身与边相连，边有三种类型.</p>
<p>值边用于将值传递给可能使用它们的节点。在下面的示例中，值1和5将使用值边传递给加法节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+---------+        +---------+</span><br><span class="line">|         |        |         |</span><br><span class="line">|    1    |        |    5    |</span><br><span class="line">|         |        |         |</span><br><span class="line">+----+----+        +----+----+</span><br><span class="line">     ^                  ^</span><br><span class="line">     |                  |</span><br><span class="line">     |   +----------+   |</span><br><span class="line">     |   |          |   |</span><br><span class="line">     +---+ addition +---+</span><br><span class="line">         |          |</span><br><span class="line">         +----------+</span><br></pre></td></tr></table></figure>

<p>控制边用于定义控制流。例如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">      +---------+         +---------+</span><br><span class="line">      |         |         |         |</span><br><span class="line">      |    5    |         |    8    |</span><br><span class="line">      |         |         |         |</span><br><span class="line">      +-------+-+         +--+------+</span><br><span class="line">              ^              ^</span><br><span class="line">  value edge  |              |  value edge</span><br><span class="line">              |              |</span><br><span class="line">            +-+--------------+-+</span><br><span class="line">            |                  |</span><br><span class="line">            |  NumberLessThan  |</span><br><span class="line">            |                  |</span><br><span class="line">            +---------+--------+</span><br><span class="line">                      ^</span><br><span class="line">                      | value edge</span><br><span class="line">              +-------+------+</span><br><span class="line">              |              |</span><br><span class="line">              |    Branch    |</span><br><span class="line">              |              |</span><br><span class="line">              +-------+------+</span><br><span class="line">  control edge        |           control edge</span><br><span class="line">       +--------------+-------------+</span><br><span class="line">       |                            |</span><br><span class="line">+------+------+              +------+-------+</span><br><span class="line">|             |              |              |</span><br><span class="line">|   If True   |              |   If False   |</span><br><span class="line">|             |              |              |</span><br><span class="line">+------+------+              +-------+------+</span><br><span class="line">       |                             |</span><br><span class="line">       v                             v</span><br><span class="line">+------+------+               +------+------+</span><br><span class="line">|             |               |             |</span><br><span class="line">|      Do     |               |      Do     |</span><br><span class="line">|  Something  |               |  Something  |</span><br><span class="line">|             |               |     Else    |</span><br><span class="line">+-------------+               +-------------+</span><br></pre></td></tr></table></figure>

<p>最后，效果边用于显示改变程序状态的操作顺序。这些边由虚线定义(其他两种边用实线绘制)。理解效果边的一种方法是考虑这样一种场景: 加载对象的属性，修改它，然后将其存储回对象中。在一个节点海图中，负载节点将有一条效果输出边进入修改节点，而修改节点将有一条效果输出边进入存储节点。这样，引擎就知道操作的顺序是load -&gt; modify -&gt; store.</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2FyLWUuZ2l0aHViLmlvL2Jsb2cvMjAxOS8wMS8yOC9pbnRyb2R1Y3Rpb24tdG8tdHVyYm9mYW4vI2VmZmVjdC1lZGdlcw==">下面的图片来自这篇博文，展示了边缘效果<i class="fa fa-external-link-alt"></i></span>:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v83.jpg"></li>
</ul>
<p>Turbolizer边缘效应</p>
<p>来看看前面所展示的add函数的节点海表示。为此，使用Turbolizer，这是V8开发者创建的一个工具，用来查看各个优化阶段的TurboFan节点海图。</p>
<p>在v8的根目录下设置Turbolizer(确保首先安装最新版本的npm和nodejs):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> tools/turbolizer</span><br><span class="line">$ npm i</span><br><span class="line">$ npm run-script build</span><br><span class="line">$ python3 -m http.server 1337</span><br></pre></td></tr></table></figure>

<p>一旦这一步完成，访问 <span class="exturl" data-url="aHR0cHM6Ly9sb2NhbGhvc3Q6MTMzNy8=">https://localhost:1337<i class="fa fa-external-link-alt"></i></span> 在Chrome或Chromium(必须是这些浏览器之一)，会看到以下输出:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v84.jpg"></li>
</ul>
<p>Turbolizer主屏幕</p>
<p>Turbolizer的工作方式是通过使用–trace-turbo选项运行V8来生成.json文件。例如，可以运行add函数的代码如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// test.js</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> add(val1, val2) &#123;</span><br><span class="line">  <span class="built_in">return</span> val1 + val2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">let</span> i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">  add(5, 10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/projects/v8/v8/out/x64.release$ ./d8 --trace-turbo test.js </span><br><span class="line">Concurrent recompilation has been disabled <span class="keyword">for</span> tracing.</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Begin compiling method  using TurboFan</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Finished compiling method  using TurboFan</span><br><span class="line"></span><br><span class="line">~/projects/v8/v8/out/x64.release$ ls turbo-*</span><br><span class="line">turbo-0x20b08210004-0.json</span><br></pre></td></tr></table></figure>

<p>turbo-*。看到的json文件是需要上传到Turbolizer。点击Turbolizer右上方的按钮，上传文件，应该看到:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v85.jpg"></li>
</ul>
<p>Turbolizer添加功能 - 图形构建阶段</p>
<p>在左边，可以看到实际的源代码，而在右边，可以看到生成的机器码。在中间，有海节点图，目前有很多节点隐藏(这是默认行为).</p>
<p>将在类型阶段查看所有节点，因为想了解TurboFan是如何对函数进行类型输入的。从顶部的下拉菜单中，选择V8.TFTyper选项。接下来，点击“显示所有节点”按钮，然后点击“布局图”按钮，最后点击“切换类型”按钮。这将显示每个节点，整齐地显示图表，并显示TurboFan推测的类型.</p>
<p>当前的图形有太多的节点，无法在一个截图中查看，所以将有选择地隐藏不重要的节点。如果想知道如何知道哪些节点是重要的，哪些节点不是，这只是基于之前使用Turbolizer的知识。建议尝试不同的测试代码，看看Turbolizer是如何布置节点海图的，以便了解更多. <span class="exturl" data-url="aHR0cHM6Ly9kb2FyLWUuZ2l0aHViLmlvL2Jsb2cvMjAxOS8wMS8yOC9pbnRyb2R1Y3Rpb24tdG8tdHVyYm9mYW4v">之前提到的博客文章<i class="fa fa-external-link-alt"></i></span>也要看一些例子.</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/simple-v86.jpg"></li>
</ul>
<p>Turbolizer添加函数型相位</p>
<ul>
<li>会注意到以下几点:</li>
</ul>
<ol>
<li><p>一开始，有一个循环节点，它表示将要进入一个循环。从这里出来的、进入Branch和LoopExit节点的边是控制边。</p>
</li>
<li><p>使用Any类型的Phi节点和使用Range(10000, 10000)类型的NumberConstant[10000]节点将被传递给使用Boolean类型的SpeculativeNumberLessThan节点。节点是循环变量，它将与这里的NumberConstant[10000]进行比较，看它是否小于10000。这里的边是值边。</p>
</li>
<li><p>SpeculativeNumberLessThan节点引出一个分支节点，该分支节点又引出一个IfTrue或IfFalse节点。如果到达了IfFalse节点(即loop变量不小于10000)，那么只需执行一个LoopExit。</p>
</li>
<li><p>在IfTrue分支中，会发生两件事。首先，使用SpeculativeSafeIntegerAdd将两个常量5和10相加，该常量已正确键入范围(15,15)。其次，看到循环变量被添加了一个常量1。用于此添加的SpeculativeSafeIntegerAdd节点的类型是一个范围(-9007199254740991,9007199254740991)。这样做是因为loop变量的初始类型是Any，这意味着TurboFan需要处理所有可能的情况，其中Any类型可以添加到常量1。这刚好是一个很大的范围。</p>
</li>
<li><p>分支之间的边，IfTrue和IfFalse边都是控制边。</p>
</li>
<li><p>TurboFan类型编号有一个范围(最小，最大)。如果它们被推测为只有一个可能的值，那么最小值和最大值是相等的，否则它们就不相等(如循环变量的情况)。</p>
</li>
<li><p>TurboFan也做了另一个优化。它友好地将add函数内联到循环中(注意没有jcall指令，这是节点海图调用函数的方式)。</p>
</li>
</ol>
<p>结果值返回省略了出口的情况，但可以在自己的TurboFan图上看，如果好奇的话。图中也没有显示效果边，但这是因为这里没有真正改变程序中任何变量/对象的状态的操作。</p>
<p>本节的主要内容如下:</p>
<ul>
<li><p>了解如何使用TurboFan来查看优化代码的节点图海。</p>
</li>
<li><p>对节点不同类型边的理解。</p>
</li>
<li><p>了解节点的类型。这对于下一节的第二个poc的解释尤其重要。</p>
</li>
<li><p>对TurboFan控制流工作原理的粗略了解。注意，当说到控制流时，并不是指分支节点，而是指如何确定节点执行的顺序。使用 “布局图” 选项将使TurboFan大致顺序的图形化，这样可以阅读它自顶向下的方法。它通过跟踪每个节点的效果输出边来了解顺序，但这并不总是100%准确的，所以需要一边做一边弄清楚。当然，将根据需要在这篇文章中解释一切，所以不必担心没有完全理解这一点。</p>
</li>
</ul>
<h2 id="重新访问第二个POC"><a href="#重新访问第二个POC" class="headerlink" title="重新访问第二个POC"></a>重新访问第二个POC</h2><p>记住以上所有信息后，现在就可以完成第二个poc的其余部分了。</p>
<h3 id="欺骗TYPER"><a href="#欺骗TYPER" class="headerlink" title="欺骗TYPER"></a>欺骗TYPER</h3><p>第二个poc的其余部分如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//在这个<span class="string">&#x27;splice&#x27;</span>调用之后，调用giant_array.Length = 0x3ffffff = 67108863</span><br><span class="line">giant_array.splice(giant_array.length, 0, 3.3, 3.3, 3.3);</span><br><span class="line"></span><br><span class="line">length_as_double =</span><br><span class="line">    new Float64Array(new BigUint64Array([0x2424242400000000n]).buffer)[0];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> trigger(array) &#123;</span><br><span class="line">  var x = array.length;</span><br><span class="line">  x -= 67108861;</span><br><span class="line">  x = Math.max(x, 0);</span><br><span class="line">  x *= 6;</span><br><span class="line">  x -= 5;</span><br><span class="line">  x = Math.max(x, 0); // [1]</span><br><span class="line"></span><br><span class="line">  <span class="built_in">let</span> corrupting_array = [0.1, 0.1];</span><br><span class="line">  <span class="built_in">let</span> corrupted_array = [0.1];</span><br><span class="line"></span><br><span class="line">  corrupting_array[x] = length_as_double;</span><br><span class="line">  <span class="built_in">return</span> [corrupting_array, corrupted_array];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">let</span> i = 0; i &lt; 30000; ++i) &#123;</span><br><span class="line">  trigger(giant_array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The way length_of_double is defined is just one way to store an actual floating point value into a variable in V8. Remember that JavaScript only has a concept of a Number and a BigInteger. What Sergey does here is he stores the BigInteger value 0x2424242400000000 into a BigUint64Array, and then creates a new Float64Array using the same buffer (backing store) as the BigUint64Array. He then simply accesses the 0x2424242400000000 value through the float array and stores it in length_as_double. You will see how this is used later.</p>
<p>Let’s start off by looking at the first part of the trigger function and see how it works. We’ll start off with the sea of nodes graph, specifically in the typer phase. Do a ./d8 –trace-turbo poc.js, open up the newly generated turbo-trigger-0.json file in Turbolizer, and switch to the Typer phase. I’ll start off by only showing the nodes that are created for the function until we get to the line marked with [1]:</p>
<p>未完持续。。。</p>
<h2 id="译自"><a href="#译自" class="headerlink" title="译自"></a>译自</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWx0dGFtLmNvbS9ibG9nL3NpbXBsZS1idWdzLXdpdGgtY29tcGxleC1leHBsb2l0cy8jY29udGVudA==">SIMPLE BUGS WITH COMPLEX EXPLOITS<i class="fa fa-external-link-alt"></i></span></li>
</ul>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="lUc1f3r11 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="lUc1f3r11 Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>lUc1f3r11
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://fdlucifer.github.io/2021/01/25/v8-simple-bug-with-complex-exploits/" title="v8中简单bug的复杂漏洞">https://fdlucifer.github.io/2021/01/25/v8-simple-bug-with-complex-exploits/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/24/JIT-engines-exploitation/" rel="prev" title="JavaScript-JIT引擎逻辑漏洞利用">
      <i class="fa fa-chevron-left"></i> JavaScript-JIT引擎逻辑漏洞利用
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/27/hunting/" rel="next" title="Hack-The-Box-pwn-challenge[Hunting]">
      Hack-The-Box-pwn-challenge[Hunting] <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B2%E4%B8%80%E7%82%B9%E5%8E%86%E5%8F%B2"><span class="nav-number">3.</span> <span class="nav-text">讲一点历史</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A82017%E5%B9%B4%E4%B9%8B%E5%89%8DV8"><span class="nav-number">3.1.</span> <span class="nav-text">在2017年之前V8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#THE-CODESTUBASSEMBLER"><span class="nav-number">3.2.</span> <span class="nav-text">THE CODESTUBASSEMBLER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TORQUE"><span class="nav-number">3.3.</span> <span class="nav-text">TORQUE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#THE-REASON-FOR-THE-BUG"><span class="nav-number">3.4.</span> <span class="nav-text">THE REASON FOR THE BUG</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-bug"><span class="nav-number">4.</span> <span class="nav-text">The bug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#v8%E4%B8%AD%E7%9A%84%E6%95%B0%E7%BB%84"><span class="nav-number">5.</span> <span class="nav-text">v8中的数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E6%95%B0%E7%BB%84"><span class="nav-number">6.</span> <span class="nav-text">内存中的数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%83%E7%B4%A0%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.</span> <span class="nav-text">元素类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#THE-POCS"><span class="nav-number">8.</span> <span class="nav-text">THE POCS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AApoc"><span class="nav-number">9.</span> <span class="nav-text">第一个poc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AApoc-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="nav-number">10.</span> <span class="nav-text">第二个poc-第一部分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TURBOFAN"><span class="nav-number">11.</span> <span class="nav-text">TURBOFAN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%86%E5%8F%B2"><span class="nav-number">11.1.</span> <span class="nav-text">历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%95%E6%9C%BA%E4%BC%98%E5%8C%96"><span class="nav-number">11.2.</span> <span class="nav-text">投机优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E9%98%B6%E6%AE%B5"><span class="nav-number">12.</span> <span class="nav-text">优化阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%9A%84%E6%B5%B7%E6%B4%8B"><span class="nav-number">12.1.</span> <span class="nav-text">节点的海洋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E8%AE%BF%E9%97%AE%E7%AC%AC%E4%BA%8C%E4%B8%AAPOC"><span class="nav-number">13.</span> <span class="nav-text">重新访问第二个POC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AC%BA%E9%AA%97TYPER"><span class="nav-number">13.1.</span> <span class="nav-text">欺骗TYPER</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%91%E8%87%AA"><span class="nav-number">14.</span> <span class="nav-text">译自</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lUc1f3r11"
      src="/images/lucifer11.jpg">
  <p class="site-author-name" itemprop="name">lUc1f3r11</p>
  <div class="site-description" itemprop="description">all things about infosec & ctf</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail → mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ19saVRlaDRSMUZNYnBWeGxwTWUtdnc=" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC_liTeh4R1FMbpVxlpMe-vw"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lUc1f3r11</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">29:13</span>
</div>
  <div class="powered-by">Powered by <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9tdXNlLnRoZW1lLW5leHQub3Jn">NexT.Muse</span>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
